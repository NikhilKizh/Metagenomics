#Thesis
#NikhilKizhakkepath
#Guide: Dr Alexey Larionov
#SoilMetagenomics

#tutorial followed: #tutorial : https://docs.qiime2.org/2023.5/tutorials/moving-pictures/

# Analysis
#prerequisites : metadata.tsv trimmed demultipluxed .qza file
# Denoising With Qiime

#trim = 0 :Not trimming 5' end
#trunc = f 186 r 203 (from analysing interactive plot: 25% score < 30 cutoff)
#reference : https://www.youtube.com/watch?v=181bMy9YB9I&list=PLbVDKwGpb3XmvnTrU40zHRT7NZWWVNUpt&index=13
####

qiime dada2 denoise-paired \
  --i-demultiplexed-seqs s03_pe_dmx_trim.qza \
  --p-trim-left-f 0 \
  --p-trim-left-r 0 \ 
  --p-trunc-len-f 186 \
  --p-trunc-len-r 203 \
  --o-representative-sequences 16S_rep_seqs_dada2.qza \
  --o-table 16S_table_dada2.qza \
  --o-denoising-stats 16S_stats_dada2.qza


 # Visualising stats metadata

 qiime metadata tabulate \
> --m-input-file 16S_stats_dada2.qza \
> --o-visualization 16S_stats_dada2.qzv

# visualising feature table metadata

Final % qiime feature-table summarize \
  --i-table 16S_table_dada2.qza \
  --o-visualization 16S_table_dada2.qzv \
  --m-sample-metadata-file 16Smetadata.tsv

#visualising rep seq data

qiime feature-table tabulate-seqs \
  --i-data 16S_rep_seqs_dada2.qza \ 
  --o-visualization 16S_rep-seqs_dada2.qzv


# generating phylogenetic tree

qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences 16S_rep_seqs_dada2.qza \ 
  --o-alignment 16S_aligned-rep-seqs.qza \
  --o-masked-alignment 16S_masked-aligned-rep-seqs.qza \
  --o-tree 16S_unrooted-tree.qza \
  --o-rooted-tree 16S_rooted-tree.qza


# core metrics calculation: Phylogeny
# sampling depth 44300
qiime diversity core-metrics-phylogenetic \
  --i-phylogeny 16S_rooted-tree.qza \ 
  --i-table 16S_table_dada2.qza \
  --p-sampling-depth 44300 \
  --m-metadata-file 16Smetadata.tsv \ 
  --output-dir core-metrics-results


# Alpha group significance visualisation

qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/faith_pd_vector.qza \
  --m-metadata-file 16Smetadata.tsv \
  --o-visualization core-metrics-results/faith-pd-group-significance.qzv


#evenness visualization

qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/evenness_vector.qza \
  --m-metadata-file 16Smetadata.tsv \
  --o-visualization core-metrics-results/evenness-group-significance.qzv

# beta-group_significance_treatment

 qiime diversity beta-group-significance --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza --m-metadata-file metadata16S.tsv --m-metadata-column Treatment  --o-visualization core-metrics-results/beta-group-significance_Treatment.qzv --p-pairwise

#beta-group-significance_Day

qiime diversity beta-group-significance --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza --m-metadata-file metadata16S.tsv --m-metadata-column Day  --o-visualization core-metrics-results/beta-group-significance_Day.qzv --p-pairwise

#beta-group-significance_Replicate

qiime diversity beta-group-significance --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza --m-metadata-file metadata16S.tsv --m-metadata-column Replicate  --o-visualization core-metrics-results/beta-group-significance_Replicate.qzv --p-pairwise


# Emperor plot _days

edem@rn-dynamic-221-019 Final % qiime emperor plot \
  --i-pcoa core-metrics-results/unweighted_unifrac_pcoa_results.qza \
  --m-metadata-file metadata16S.tsv \
  --p-custom-axes Day \      
  --o-visualization core-metrics-results/unweighted-unifrac-emperor-days-Day.qzv


# diversity_alpha_rarefaction
# pmax depth = median =86000 

qiime diversity alpha-rarefaction \
  --i-table 16S_table_dada2.qza \
  --i-phylogeny 16S_rooted-tree.qza \
  --p-max-depth 86000 \
  --m-metadata-file metadata16S.tsv \
  --o-visualization 16S_alpha-rarefaction.qzv


# Taxonomy
# greenegene16S database
# 

qiime feature-classifier classify-sklearn \
  --i-classifier gg-13-8-99-nb-classifier.qza \        
  --i-reads 16S_rep_seqs_dada2.qza \
  --o-classification 16S_taxonomy.qza


#visualization

qiime metadata tabulate \
  --m-input-file 16S_taxonomy.qza \
  --o-visualization 16S_taxonomy.qzv

# Taxonomy Barplot

qiime taxa barplot \
  --i-table 16S_table_dada2.qza \
  --i-taxonomy 16S_taxonomy.qza \
  --m-metadata-file metadata16S.tsv \ 
  --o-visualization 16S_taxa-bar-plots.qzv

#Taxonomy Using greengene2 database

qiime feature-classifier classify-sklearn \
  --i-classifier gg_2022_10_backbone.v4.nb.qza \ 
  --i-reads 16S_rep_seqs_dada2.qza \
  --o-classification 16S_gg2_taxonomy.qza

#Taxonomy visualization

qiime metadata tabulate \
  --m-input-file 16S_gg2_taxonomy.qza \
  --o-visualization 16S_gg2_taxonomy.qzv


#Taxonomy barplot

qiime taxa barplot --i-table 16S_table_dada2.qza --i-taxonomy 16S_gg2_taxonomy.qza  --m-metadata-file metadata16S.tsv --o-visualization 16S_gg2_taxa-bar-plots.qzv

#Differential Abundance Analysis ANCOM
#
